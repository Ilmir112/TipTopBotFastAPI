{% extends "base.html" %}
<body>
<div class="container">
    <div class="main">
        <h1>Please log in</h1>
        <p class="paragraph">Only selected users may see this&nbsp;site.</p>

        <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="{{ bot_username }}"
                data-size="large" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
        <script type="text/javascript">
            function onTelegramAuth(user) {
                fetch('/auth/telegram-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(user),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.access_token) {
                            document.cookie = `access_token=${data.access_token}; path=/; httponly; samesite=Lax`;
                            window.location.href = '/';
                        } else {
                            alert('Ошибка входа: ' + (data.detail || 'Неизвестная ошибка'));
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert('Произошла ошибка при входе через Telegram.');
                    });
            }
        </script>
    </div>
</div>
</body>